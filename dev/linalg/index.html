<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear algebra of SnpArray · SnpArrays.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">SnpArrays.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">SnpArrays.jl</a></li><li class="is-active"><a class="tocitem" href>Linear algebra of SnpArray</a><ul class="internal"><li><a class="tocitem" href="#y-Ax"><span><span>$y = Ax$</span></span></a></li><li><a class="tocitem" href="#AT-x"><span><span>$A^T x$</span></span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Linear algebra of SnpArray</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear algebra of SnpArray</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/OpenMendel/SnpArrays.jl/blob/master/docs/src/linalg.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Linear-algebra-of-SnpArray"><a class="docs-heading-anchor" href="#Linear-algebra-of-SnpArray">Linear algebra of SnpArray</a><a id="Linear-algebra-of-SnpArray-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-algebra-of-SnpArray" title="Permalink"></a></h1><p>SnpArrays.jl supports three modes of matrix-vector multiplications.</p><ol><li>Direct operations on a plink-formatted <code>SnpArray</code>: <code>SnpLinAlg</code></li><li>Operations on transformed <code>BitMatrix</code>es: <code>SnpBitMatrix</code></li><li>Direct operations on a plink-formatted data on an Nvidia GPU: <code>CuSnpArray</code>.</li></ol><p><code>SnpLinAlg</code> and <code>SnpBitMatrix</code> use Chris Elrod&#39;s <a href="https://github.com/chriselrod/LoopVectorization.jl">LoopVectorization.jl</a> internally. It is much faster on machines with AVX support. <code>CuSnpArray</code> uses <a href="https://juliagpu.gitlab.io/CUDA.jl/">CUDA.jl</a> internally. On this page, we compare these three.</p><pre><code class="language-julia">versioninfo()</code></pre><pre><code class="language-none">Julia Version 1.4.1
Commit 381693d3df* (2020-04-14 17:20 UTC)
Platform Info:
  OS: Linux (x86_64-pc-linux-gnu)
  CPU: Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-8.0.1 (ORCJIT, skylake)</code></pre><pre><code class="language-julia">using SnpArrays</code></pre><pre><code class="language-julia">const EUR = SnpArray(SnpArrays.datadir(&quot;EUR_subset.bed&quot;))</code></pre><pre><code class="language-none">379×54051 SnpArray:
 0x03  0x03  0x03  0x02  0x02  0x03  …  0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x02  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x03  0x03  0x03     0x02  0x02  0x02  0x03  0x03  0x02
 0x03  0x03  0x03  0x00  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x03  0x03     0x02  0x02  0x02  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03  …  0x03  0x03  0x03  0x03  0x03  0x02
 0x02  0x03  0x03  0x02  0x02  0x03     0x03  0x03  0x02  0x02  0x03  0x03
 0x02  0x03  0x03  0x03  0x02  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x03  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03  …  0x03  0x03  0x02  0x02  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x02
 0x03  0x02  0x03  0x02  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
    ⋮                             ⋮  ⋱     ⋮                             ⋮
 0x03  0x03  0x03  0x00  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x02  0x03     0x02  0x02  0x02  0x03  0x02  0x03
 0x03  0x03  0x03  0x02  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x03  0x03  …  0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x00  0x03     0x02  0x02  0x02  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03  …  0x03  0x03  0x02  0x02  0x03  0x03
 0x03  0x03  0x03  0x00  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x00  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03</code></pre><p>Let&#39;s try with EUR data repeated 100 times: 37900 by 54051.</p><pre><code class="language-julia">EUR_10 = [EUR; EUR; EUR; EUR; EUR; EUR; EUR; EUR; EUR; EUR]
EUR_100 = [EUR_10; EUR_10; EUR_10; EUR_10; EUR_10; EUR_10; EUR_10; EUR_10; EUR_10; EUR_10]</code></pre><pre><code class="language-none">37900×54051 SnpArray:
 0x03  0x03  0x03  0x02  0x02  0x03  …  0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x02  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x03  0x03  0x03     0x02  0x02  0x02  0x03  0x03  0x02
 0x03  0x03  0x03  0x00  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x03  0x03     0x02  0x02  0x02  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03  …  0x03  0x03  0x03  0x03  0x03  0x02
 0x02  0x03  0x03  0x02  0x02  0x03     0x03  0x03  0x02  0x02  0x03  0x03
 0x02  0x03  0x03  0x03  0x02  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x03  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03  …  0x03  0x03  0x02  0x02  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x02
 0x03  0x02  0x03  0x02  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
    ⋮                             ⋮  ⋱     ⋮                             ⋮
 0x03  0x03  0x03  0x00  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x02  0x03     0x02  0x02  0x02  0x03  0x02  0x03
 0x03  0x03  0x03  0x02  0x02  0x03  …  0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x00  0x00  0x03     0x02  0x02  0x02  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x03  0x03  …  0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x03  0x03  0x03     0x03  0x03  0x02  0x02  0x03  0x03
 0x03  0x03  0x03  0x00  0x03  0x03     0x03  0x03  0x03  0x03  0x03  0x03
 0x02  0x03  0x03  0x02  0x00  0x02     0x03  0x03  0x03  0x03  0x03  0x03
 0x03  0x03  0x03  0x02  0x02  0x03     0x03  0x03  0x03  0x03  0x03  0x03</code></pre><p>We create instnaces of SnpLinAlg, SnpBitmatrix and CuSnpArray:</p><pre><code class="language-julia">EUR_100_bm = SnpBitMatrix{Float64}(EUR_100; model=ADDITIVE_MODEL, center=false, scale=false)
EUR_100_sla = SnpLinAlg{Float64}(EUR_100; model=ADDITIVE_MODEL, center=false, scale=false);</code></pre><pre><code class="language-julia">ENV[&quot;JULIA_CUDA_USE_BINARYBUILDER&quot;] = &quot;false&quot;
using CUDA
EUR_100_cu = CuSnpArray{Float64}(EUR_100; model=ADDITIVE_MODEL, center=false, scale=false);</code></pre><pre><code class="language-none">┌ Warning: `haskey(::TargetIterator, name::String)` is deprecated, use `Target(; name = name) !== nothing` instead.
│   caller = llvm_compat(::VersionNumber) at compatibility.jl:176
└ @ CUDA /home/kose/.julia/packages/CUDA/5t6R9/deps/compatibility.jl:176</code></pre><h2 id="y-Ax"><a class="docs-heading-anchor" href="#y-Ax"><span>$y = Ax$</span></a><a id="y-Ax-1"></a><a class="docs-heading-anchor-permalink" href="#y-Ax" title="Permalink"></a></h2><pre><code class="language-julia">using LinearAlgebra
using BenchmarkTools</code></pre><pre><code class="language-julia">v1 = randn(size(EUR_100, 1))
v2 = randn(size(EUR_100, 2));</code></pre><p>Direct linear algebra on a SnpArray: </p><pre><code class="language-julia">@benchmark LinearAlgebra.mul!($v1, $EUR_100_sla, $v2)</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     2.455 s (0.00% GC)
  median time:      2.460 s (0.00% GC)
  mean time:        2.462 s (0.00% GC)
  maximum time:     2.470 s (0.00% GC)
  --------------
  samples:          3
  evals/sample:     1</code></pre><p>The below is the benchmark for SnpBitMatrix:</p><pre><code class="language-julia">@benchmark (LinearAlgebra.mul!($v1, $EUR_100_bm, $v2))</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     1.301 s (0.00% GC)
  median time:      1.306 s (0.00% GC)
  mean time:        1.306 s (0.00% GC)
  maximum time:     1.311 s (0.00% GC)
  --------------
  samples:          4
  evals/sample:     1</code></pre><p>SnpBitMatrix is about twice as fast as SnpLinAlg. However, note that it allocates additional BitMatrixes of the same size as the plink file itself.</p><p>Now let&#39;s try CUDA. The device is Nvidia Titan V.</p><pre><code class="language-julia">using Adapt</code></pre><p>Moving data to GPU: </p><pre><code class="language-julia">v1_d = adapt(CuArray{Float64}, v1)
v2_d = adapt(CuArray{Float64}, v2);</code></pre><pre><code class="language-julia">using BenchmarkTools
@benchmark LinearAlgebra.mul!($v1_d, $EUR_100_cu, $v2_d)</code></pre><pre><code class="language-none">┌ Warning: `Target(triple::String)` is deprecated, use `Target(; triple = triple)` instead.
│   caller = ip:0x0
└ @ Core :-1





BenchmarkTools.Trial: 
  memory estimate:  1.44 KiB
  allocs estimate:  54
  --------------
  minimum time:     22.021 ms (0.00% GC)
  median time:      22.162 ms (0.00% GC)
  mean time:        22.666 ms (0.00% GC)
  maximum time:     44.924 ms (0.00% GC)
  --------------
  samples:          221
  evals/sample:     1</code></pre><p>The speedup is obvious. Let&#39;s check correctness:</p><pre><code class="language-julia">isapprox(collect(v1_d), v1)</code></pre><pre><code class="language-none">true</code></pre><h2 id="AT-x"><a class="docs-heading-anchor" href="#AT-x"><span>$A^T x$</span></a><a id="AT-x-1"></a><a class="docs-heading-anchor-permalink" href="#AT-x" title="Permalink"></a></h2><pre><code class="language-julia">v1 = randn(size(EUR_100, 1))
v2 = randn(size(EUR_100, 2))
v1_d = adapt(CuArray{Float64}, v1)
v2_d = adapt(CuArray{Float64}, v2);</code></pre><pre><code class="language-julia">@benchmark LinearAlgebra.mul!($v2, transpose($EUR_100_sla), $v1)</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  16 bytes
  allocs estimate:  1
  --------------
  minimum time:     1.601 s (0.00% GC)
  median time:      1.605 s (0.00% GC)
  mean time:        1.607 s (0.00% GC)
  maximum time:     1.616 s (0.00% GC)
  --------------
  samples:          4
  evals/sample:     1</code></pre><pre><code class="language-julia">@benchmark (LinearAlgebra.mul!($v2, transpose($EUR_100_bm), $v1))</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  16 bytes
  allocs estimate:  1
  --------------
  minimum time:     601.766 ms (0.00% GC)
  median time:      609.034 ms (0.00% GC)
  mean time:        617.225 ms (0.00% GC)
  maximum time:     657.481 ms (0.00% GC)
  --------------
  samples:          9
  evals/sample:     1</code></pre><pre><code class="language-julia">@benchmark LinearAlgebra.mul!($v2_d, transpose($EUR_100_cu), $v1_d)</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  1.42 KiB
  allocs estimate:  53
  --------------
  minimum time:     27.659 ms (0.00% GC)
  median time:      27.871 ms (0.00% GC)
  mean time:        28.316 ms (0.00% GC)
  maximum time:     33.411 ms (0.00% GC)
  --------------
  samples:          177
  evals/sample:     1</code></pre><pre><code class="language-julia">isapprox(collect(v2_d), v2)</code></pre><pre><code class="language-none">true</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« SnpArrays.jl</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Sunday 26 July 2020 09:36">Sunday 26 July 2020</span>. Using Julia version 1.1.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
